"""
–ò–º–ø–æ—Ä—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
"""
import asyncio
import os
import re
from datetime import datetime
from database_pg import DatabasePG
from dotenv import load_dotenv

load_dotenv()


# –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ (—Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ ‚Üí –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –ë–î)
PRODUCT_MAPPING = {
    "–º–∞–Ω–≥–æ–≤–æ–µ –ø—é—Ä–µ": "–ú–∞–Ω–≥–æ –ø—é—Ä–µ",
    "–ø–µ—Ä—Å–∏–∫–æ–≤–æ–µ –ø—é—Ä–µ": "–ü–µ—Ä—Å–∏–∫ –ø—é—Ä–µ",
    "–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –Ω–∞–ø–∏—Ç–∫–∞ —Å –∫—É—Å–æ—á–∫–∞–º–∏ –∞–ø–µ–ª—å—Å–∏–Ω–∞": "–ê–ø–µ–ª—å—Å–∏–Ω –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç",
    "–º–∞–ª–∏–Ω–∞ —Å–æ–∫": "–ú–∞–ª–∏–Ω–∞ —Å–æ–∫",
    "–≤–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π —Å–æ–∫": "–í–∏–Ω–æ–≥—Ä–∞–¥ —Å–æ–∫",
    "–≤–∏–Ω–æ–≥—Ä–∞–¥ –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π": "–í–∏–Ω–æ–≥—Ä–∞–¥ –∫–æ–Ω—Å–µ—Ä–≤",
    "–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç": "–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç",
    "–ª–∞—Ç—Ç–µ": "–õ–∞—Ç—Ç–µ",
    "—è–Ω—á–∂–∏ –≥–∞–Ω–ª—É": "–Ø–Ω—á–∂–∏ –ì–∞–Ω–ª—É",
    "–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç —Å–æ–∫–∞ –º–∞—Ä–∞–∫—É–π–∏": "–ú–∞—Ä–∞–∫—É–π—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç",
    "—Å–∏—Ä–æ–ø –∏–∑ —Ñ—Ä—É–∫—Ç–æ–≤–æ–≥–æ —Å–æ–∫–∞": "–§—Ä—É–∫—Ç —Å–∏—Ä–æ–ø",
    "–∫–æ–∫–æ—Å–æ–≤—ã–µ –∫—É—Å–æ—á–∫–∏": "–ö–æ–∫–æ—Å –∫—É—Å–æ—á–∫–∏",
    "—Ç–∞–ø–∏–æ–∫–∞": "–¢–∞–ø–∏–æ–∫–∞",
    "—Ö—Ä—É—Å—Ç—è—â–∏–µ —Ä–æ–∂–∫–∏": "–•—Ä—É—Å—Ç—è—â–∏–µ —Ä–æ–∂–∫–∏",
    "–ø–æ—Ä–æ—à–æ–∫ —Å–æ –≤–∫—É—Å–æ–º –º–æ–ª–æ—á–Ω–æ–≥–æ –∫–æ–∫—Ç–µ–π–ª—è (—Å–ª–∏–≤–æ—á–Ω—ã–π)": "–ú–æ–ª–æ—á–Ω—ã–π –ø–æ—Ä–æ—à–æ–∫ (—Å–ª–∏–≤–æ—á–Ω—ã–π)",
    "–ø–æ—Ä–æ—à–æ–∫ —Å–æ –≤–∫—É—Å–æ–º –º–æ–ª–æ—á–Ω–æ–≥–æ –∫–æ–∫—Ç–µ–π–ª—è (—à–æ–∫–æ–ª–∞–¥–Ω—ã–π)": "–ú–æ–ª–æ—á–Ω—ã–π –ø–æ—Ä–æ—à–æ–∫ (—à–æ–∫–æ–ª–∞–¥–Ω—ã–π)",
    "–∫–æ–º–ø–∞–Ω—å–æ–Ω –¥–ª—è —á–∞—è —Å –º–æ–ª–æ–∫–æ–º": "–ö–æ–º–ø–∞–Ω—å–æ–Ω –¥–ª—è —á–∞—è",
    "—Ñ—Ä—É—Ç–æ–≤—ã–π –º—ë–¥": "–§—Ä—É–∫—Ç–æ–≤—ã–π –º—ë–¥",
    "–ø–æ—Ä–æ—à–æ–∫ –¥–ª—è –∫–∞—Ä–∞–º–µ–ª—å–Ω–æ–≥–æ –ø—É–¥–∏–Ω–≥–∞": "–ö–∞—Ä–∞–º–µ–ª—å–Ω—ã–π –ø—É–¥–∏–Ω–≥",
    "—á—ë—Ä–Ω—ã–π —Å–∞—Ö–∞—Ä": "–ß–µ—Ä–Ω—ã–π —Å–∞—Ö–∞—Ä",
    "—à–æ–∫–æ–ª–∞–¥–Ω—ã–π —Å–∏—Ä–æ–ø": "–®–æ–∫–æ–ª–∞–¥–Ω—ã–π —Å–∏—Ä–æ–ø",
    "–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –∫–ª—É–±–Ω–∏—á–Ω–æ–≥–æ —Å–æ–∫–∞": "–ö–ª—É–±–Ω–∏–∫–∞ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç",
    "–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –Ω–∞–ø–∏—Ç–∫–∞ —Å –∫—É—Å–æ—á–∫–∞–º–∏ —á–µ—Ä–Ω–∏–∫–∏": "–ß–µ—Ä–Ω–∏–∫–∞ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç",
    "–ø–µ—Ä—Å–∏–∫–æ–≤–æ–µ –∂–µ–ª–µ": "–ü–µ—Ä—Å–∏–∫ –∂–µ–ª–µ",
    "—Ñ–∞—Å–æ–ª—å": "–§–∞—Å–æ–ª—å",
}


def parse_date(date_str: str) -> str:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –¥–∞—Ç—É –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ '17 –Ω–æ—è–±—Ä—å' –≤ '2024-11-17'
    """
    months = {
        "—è–Ω–≤–∞—Ä": "01", "—Ñ–µ–≤—Ä–∞–ª": "02", "–º–∞—Ä—Ç": "03", "–∞–ø—Ä–µ–ª": "04",
        "–º–∞": "05", "–∏—é–Ω": "06", "–∏—é–ª": "07", "–∞–≤–≥—É—Å—Ç": "08",
        "—Å–µ–Ω—Ç—è–±—Ä": "09", "–æ–∫—Ç—è–±—Ä": "10", "–Ω–æ—è–±—Ä": "11", "–¥–µ–∫–∞–±—Ä": "12"
    }

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–µ–Ω—å –∏ –º–µ—Å—è—Ü
    match = re.match(r'(\d+)\s+(\w+)', date_str.strip())
    if not match:
        raise ValueError(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: {date_str}")

    day = int(match.group(1))
    month_str = match.group(2).lower()

    # –ù–∞—Ö–æ–¥–∏–º –º–µ—Å—è—Ü
    month = None
    for key, value in months.items():
        if month_str.startswith(key):
            month = value
            break

    if not month:
        raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Å—è—Ü: {month_str}")

    # –ì–æ–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (2024 –¥–ª—è –Ω–æ—è–±—Ä—è, –∏–Ω–∞—á–µ –º–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å)
    year = 2024

    return f"{year}-{month}-{day:02d}"


def parse_product_line(line: str) -> tuple:
    """
    –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞: '1. –ú–∞–Ω–≥–æ–≤–æ–µ –ø—é—Ä–µ 1,2 –∫–≥ ‚Äî 17'
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (–Ω–∞–∑–≤–∞–Ω–∏–µ, –≤–µ—Å_—É–ø–∞–∫–æ–≤–∫–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
    """
    # –£–±–∏—Ä–∞–µ–º –Ω–æ–º–µ—Ä –≤ –Ω–∞—á–∞–ª–µ
    line = re.sub(r'^\d+\.\s*', '', line.strip())

    # –ü–∞—Ç—Ç–µ—Ä–Ω: –Ω–∞–∑–≤–∞–Ω–∏–µ ‚Äî –≤–µ—Å ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    match = re.match(r'(.+?)\s+([\d,\.]+)\s*(\w+)\s*‚Äî\s*(\d+)', line)
    if not match:
        return None

    name = match.group(1).strip()
    weight = float(match.group(2).replace(',', '.'))
    unit = match.group(3).strip()
    quantity = int(match.group(4))

    return (name, weight, unit, quantity)


async def import_old_data(data_text: str):
    """
    –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞
    """
    database_url = os.getenv('DATABASE_URL')
    if not database_url:
        print("‚ùå DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return

    db = DatabasePG(database_url)
    await db.init_db()

    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –ë–î –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞
        products = await db.get_all_products()
        product_dict = {p['name_internal'].lower(): p for p in products}

        # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
        lines = data_text.strip().split('\n')
        current_date = None
        imported_count = 0
        skipped_count = 0

        for line in lines:
            line = line.strip()
            if not line:
                continue

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –¥–∞—Ç–∞ –∏–ª–∏ —Ç–æ–≤–∞—Ä
            if re.match(r'^\d+\s+\w+', line) and '‚Äî' not in line:
                # –≠—Ç–æ –¥–∞—Ç–∞
                try:
                    current_date = parse_date(line)
                    print(f"\nüìÖ –î–∞—Ç–∞: {current_date}")
                except Exception as e:
                    print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã '{line}': {e}")
                continue

            if not current_date:
                continue

            # –ü–∞—Ä—Å–∏–º —Ç–æ–≤–∞—Ä
            parsed = parse_product_line(line)
            if not parsed:
                continue

            name, package_weight, unit, quantity = parsed

            # –ò—â–µ–º —Ç–æ–≤–∞—Ä –≤ –ë–î
            name_lower = name.lower()
            mapped_name = PRODUCT_MAPPING.get(name_lower)

            product = None
            if mapped_name:
                product = product_dict.get(mapped_name.lower())

            if not product:
                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
                for p in products:
                    if name_lower in p['name_internal'].lower() or p['name_internal'].lower() in name_lower:
                        product = p
                        break

            if product:
                weight = quantity * package_weight
                try:
                    await db.add_stock(
                        product_id=product['id'],
                        date=current_date,
                        quantity=quantity,
                        weight=weight
                    )
                    print(f"   ‚úÖ {product['name_internal']}: {quantity} —É–ø. ({weight:.1f} {unit})")
                    imported_count += 1
                except Exception as e:
                    print(f"   ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è {name}: {e}")
                    skipped_count += 1
            else:
                print(f"   ‚ö†Ô∏è  –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω: {name}")
                skipped_count += 1

        print(f"\nüìä –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω:")
        print(f"   ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: {imported_count}")
        print(f"   ‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped_count}")

    finally:
        await db.close()


# –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–¥–µ—Å—å
OLD_DATA = """
17 –Ω–æ—è–±—Ä—å

1. –ú–∞–Ω–≥–æ–≤–æ–µ –ø—é—Ä–µ 1,2 –∫–≥ ‚Äî 17
2. –ü–µ—Ä—Å–∏–∫–æ–≤–æ–µ –ø—é—Ä–µ 1,2 –∫–≥ ‚Äî 40
3. –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –Ω–∞–ø–∏—Ç–∫–∞ —Å –∫—É—Å–æ—á–∫–∞–º–∏ –∞–ø–µ–ª—å—Å–∏–Ω–∞ 2,6 –∫–≥ ‚Äî 4
4. –ú–∞–ª–∏–Ω–∞ —Å–æ–∫ 2,6 –∫–≥ ‚Äî 4
5. –í–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π —Å–æ–∫ 2,6 –∫–≥ ‚Äî 4
6. –í–∏–Ω–æ–≥—Ä–∞–¥ –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 850 –≥ ‚Äî 22
7. –ì—Ä–µ–π–ø—Ñ—Ä—É—Ç 850 –≥ ‚Äî 7
8. –õ–∞—Ç—Ç–µ 1 –∫–≥ ‚Äî 16
9. –Ø–Ω—á–∂–∏ –ì–∞–Ω–ª—É 1 –∫–≥ ‚Äî 13
10. –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç —Å–æ–∫–∞ –º–∞—Ä–∞–∫—É–π–∏ 2 –∫–≥ ‚Äî 18
11. –°–∏—Ä–æ–ø –∏–∑ —Ñ—Ä—É–∫—Ç–æ–≤–æ–≥–æ —Å–æ–∫–∞ 12,5 –∫–≥ ‚Äî 7
12. –ö–æ–∫–æ—Å–æ–≤—ã–µ –∫—É—Å–æ—á–∫–∏ 2,5 –∫–≥ ‚Äî 17
13. –¢–∞–ø–∏–æ–∫–∞ 1 –∫–≥ ‚Äî 67
14. –•—Ä—É—Å—Ç—è—â–∏–µ —Ä–æ–∂–∫–∏ –ø–æ 400 —à—Ç—É–∫ ‚Äî 13
15. –ü–æ—Ä–æ—à–æ–∫ —Å–æ –≤–∫—É—Å–æ–º –º–æ–ª–æ—á–Ω–æ–≥–æ –∫–æ–∫—Ç–µ–π–ª—è (—Å–ª–∏–≤–æ—á–Ω—ã–π) 3 –∫–≥ ‚Äî 22
16. –ü–æ—Ä–æ—à–æ–∫ —Å–æ –≤–∫—É—Å–æ–º –º–æ–ª–æ—á–Ω–æ–≥–æ –∫–æ–∫—Ç–µ–π–ª—è (—à–æ–∫–æ–ª–∞–¥–Ω—ã–π) 3 –∫–≥ ‚Äî 32
17. –ö–æ–º–ø–∞–Ω—å–æ–Ω –¥–ª—è —á–∞—è —Å –º–æ–ª–æ–∫–æ–º 3 –∫–≥ ‚Äî 3
18. –§—Ä—É—Ç–æ–≤—ã–π –º—ë–¥ 5,5 –∫–≥ ‚Äî 13
19. –ü–æ—Ä–æ—à–æ–∫ –¥–ª—è –∫–∞—Ä–∞–º–µ–ª—å–Ω–æ–≥–æ –ø—É–¥–∏–Ω–≥–∞ 1 –∫–≥ ‚Äî 19
20. –ß—ë—Ä–Ω—ã–π —Å–∞—Ö–∞—Ä 2,5 –∫–≥ ‚Äî 3
21. –®–æ–∫–æ–ª–∞–¥–Ω—ã–π —Å–∏—Ä–æ–ø 2,5 –∫–≥ ‚Äî 4
22. –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –∫–ª—É–±–Ω–∏—á–Ω–æ–≥–æ —Å–æ–∫–∞ 2 –∫–≥ ‚Äî 7
23. –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –Ω–∞–ø–∏—Ç–∫–∞ —Å –∫—É—Å–æ—á–∫–∞–º–∏ —á–µ—Ä–Ω–∏–∫–∏ 2 –∫–≥ ‚Äî 7
24. –ü–µ—Ä—Å–∏–∫–æ–≤–æ–µ –∂–µ–ª–µ 1 –ª ‚Äî 15
25. –§–∞—Å–æ–ª—å 900 –≥ ‚Äî 30
"""


if __name__ == '__main__':
    print("üîÑ –ò–º–ø–æ—Ä—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö...")
    asyncio.run(import_old_data(OLD_DATA))
