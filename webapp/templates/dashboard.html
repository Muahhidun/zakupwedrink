{% extends "layout.html" %}

{% block title %}Дашборд | WeDrink{% endblock %}
{% block page_title %}Дашборд{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block extra_css %}
<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .metric-card {
        background: var(--bg-surface);
        padding: 24px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }

    .metric-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .metric-title {
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
    }

    .metric-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .metric-icon.primary {
        background: var(--primary-light);
        color: var(--primary);
    }

    .metric-icon.success {
        background: var(--secondary-light);
        color: var(--secondary);
    }

    .metric-icon.warning {
        background: var(--warning-light);
        color: var(--warning);
    }

    .metric-icon.danger {
        background: var(--danger-light);
        color: var(--danger);
    }

    .metric-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -1px;
    }

    .metric-footer {
        margin-top: 12px;
        font-size: 13px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .trend {
        font-weight: 600;
    }

    .trend.up {
        color: var(--secondary);
    }

    .trend.down {
        color: var(--danger);
    }

    /* Recent Activity Area */
    .dashboard-section {
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        padding: 24px;
        margin-bottom: 32px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .empty-state {
        padding: 40px 20px;
        text-align: center;
        color: var(--text-tertiary);
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in-up">
    <!-- Top Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">Остатков сдано (Сегодня)</span>
                <div class="metric-icon primary">
                    <span class="material-symbols-rounded">check_circle</span>
                </div>
            </div>
            <div class="metric-value" id="metric-stock-status">
                <div class="skeleton" style="width: 100px; height: 38px; border-radius: 4px;"></div>
            </div>
            <div class="metric-footer" id="metric-stock-footer">Загрузка...</div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">Сумма закупа (7 дней)</span>
                <div class="metric-icon warning">
                    <span class="material-symbols-rounded">payments</span>
                </div>
            </div>
            <div class="metric-value" id="metric-total-cost">
                <div class="skeleton" style="width: 150px; height: 38px; border-radius: 4px;"></div>
            </div>
            <div class="metric-footer">Ориентировочно</div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-title">Критические товары</span>
                <div class="metric-icon danger">
                    <span class="material-symbols-rounded">warning</span>
                </div>
            </div>
            <div class="metric-value" id="metric-critical">
                <div class="skeleton" style="width: 60px; height: 38px; border-radius: 4px;"></div>
            </div>
            <div class="metric-footer">Осталось на < 3 дней</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-section">
            <h2 class="section-title"><span class="material-symbols-rounded">bolt</span> Быстрые действия</h2>
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="window.location.href='/stock_input'">
                    <span class="material-symbols-rounded">edit_square</span> Ввести остатки
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/orders'">
                    <span class="material-symbols-rounded">shopping_cart</span> Сделать заказ
                </button>
            </div>
        </div>

    </div>
    {% endblock %}

    {% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await Promise.all([
                    fetchStockStatus()
                ]);
                // Additional metrics logic will go here
            } catch (e) {
                console.error('Ошибка загрузки данных дашборда', e);
            }
        });

        async function fetchStockStatus() {
            try {
                const res = await fetch('/api/stock/check');
                const data = await res.json();

                const vEl = document.getElementById('metric-stock-status');
                const fEl = document.getElementById('metric-stock-footer');

                if (data.exists) {
                    vEl.innerHTML = '<span style="color: var(--secondary)">Сдано</span>';
                    fEl.innerHTML = `За ${new Date(data.working_date).toLocaleDateString()}`;
                } else {
                    vEl.innerHTML = '<span style="color: var(--danger)">Ожидается</span>';
                    fEl.innerHTML = `Ждем сводку за ${new Date(data.working_date).toLocaleDateString()}`;
                }

                // Will fetch order sums from another endpoint or calculation soon
                // For now keep loading state or placeholder that feels real
                document.getElementById('metric-total-cost').textContent = 'В разработке';
                document.getElementById('metric-critical').textContent = '...';

            } catch (e) {
                console.error(e);
            }
        }
    </script>
    {% endblock %}