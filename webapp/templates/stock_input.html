{% extends "layout.html" %}

{% block title %}Ввод остатков | WeDrink{% endblock %}
{% block page_title %}Ввод остатков{% endblock %}
{% block nav_stock_input %}active{% endblock %}

{% block extra_css %}
<style>
    .date-info {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .existing-data-alert {
        background-color: var(--warning-light);
        border: 1px solid var(--warning);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 24px;
        display: none;
        animation: fadeInUp 0.3s ease-out;
    }

    .existing-data-alert.show {
        display: block;
    }

    .alert-header {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #B45309;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .alert-message {
        color: #B45309;
        font-size: 14px;
        margin-bottom: 16px;
    }

    /* Fixed Actions Footer */
    .bottom-actions {
        position: fixed;
        bottom: 0;
        left: 280px;
        /* offset sidebar */
        right: 0;
        padding: 16px 32px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        z-index: 50;
        transition: left var(--transition-normal);
    }

    /* Mobile adjustments */
    @media (max-width: 600px) {
        .bottom-actions {
            left: 0;
            padding: 12px 16px;
        }

        .content-body {
            padding: 12px;
            padding-bottom: 100px;
        }

        .card {
            padding: 0;
            border-radius: var(--radius-md);
        }

        /* Responsive Table */
        .table thead {
            display: none;
            /* Hide headers on mobile */
        }

        .table,
        .table tbody,
        .table tr,
        .table td {
            display: block;
            width: 100%;
        }

        .table tr {
            position: relative;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-areas:
                "name name"
                "stats input";
            grid-template-columns: 1fr auto;
            align-items: end;
            gap: 12px;
        }

        .table tr:hover {
            background-color: transparent;
        }

        .table td {
            padding: 0 !important;
            border: none !important;
        }

        .table td:nth-child(1) {
            grid-area: name;
            margin-bottom: 4px;
        }

        /* Container for Yesterday and Consumption */
        .table td:nth-child(2),
        .table td:nth-child(3) {
            display: inline-flex;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .table td:nth-child(2) {
            grid-area: stats;
            justify-self: start;
        }

        /* Insert labels for stats */
        .table td:nth-child(2)::before {
            content: 'Вчера: ';
            margin-right: 4px;
            color: var(--text-tertiary);
        }

        .table td:nth-child(3) {
            display: none;
            /* Combine or hide on mobile if too crowded */
        }

        /* Show consumption as a small badge next to yesterday */
        .mobile-consumption {
            display: inline-flex;
            margin-left: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .mobile-consumption::before {
            content: 'Расход: ';
            margin-right: 4px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .table td:nth-child(4) {
            grid-area: input;
        }

        .qty-input {
            width: 90px;
            height: 44px;
            font-size: 18px;
            border-color: var(--primary);
            background-color: var(--primary-light);
            color: var(--primary);
        }
    }

    .consumption-positive {
        color: var(--danger);
    }

    .consumption-negative {
        color: var(--secondary);
    }

    .consumption-zero {
        color: var(--text-tertiary);
    }

    .qty-input {
        width: 80px;
        text-align: center;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        transition: border-color var(--transition-fast);
        font-weight: 600;
    }

    .qty-input:focus {
        border-color: var(--primary);
        outline: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in-up">
    <div class="date-info">
        <span class="material-symbols-rounded">calendar_today</span>
        <span>Текущая дата: <strong id="currentDate">Загрузка...</strong></span>
    </div>

    <!-- Alert for existing data -->
    <div class="existing-data-alert" id="existingDataAlert">
        <div class="alert-header">
            <span class="material-symbols-rounded">warning</span>
            <span>Остатки уже внесены</span>
        </div>
        <div class="alert-message">
            Остатки за сегодняшний рабочий день уже были внесены или отправлены на проверку.<br>
            Вам нужно внести исправления?
        </div>
        <button class="btn btn-warning" onclick="loadExistingData()"
            style="background-color: #F59E0B; color: white; border: none;">
            <span class="material-symbols-rounded">edit</span> Исправить
        </button>
    </div>

    <!-- Table Container -->
    <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 80px;">
        <div class="table-container">
            <table class="table" id="stockTableBase">
                <thead>
                    <tr>
                        <th style="width: 40%">Товар</th>
                        <th style="text-align: center;">Вчера</th>
                        <th style="text-align: center;">Расход</th>
                        <th style="text-align: right; padding-right: 32px;">Остаток (уп.)</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 32px; color: var(--text-tertiary);">
                            <span class="material-symbols-rounded"
                                style="animation: spin 1s linear infinite;">sync</span>
                            <div style="margin-top: 8px;">Загрузка списка товаров...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="bottom-actions">
    <button class="btn btn-primary" id="saveBtn" onclick="saveStock()"
        style="min-width: 200px; padding: 12px 24px; font-size: 16px;">
        <span class="material-symbols-rounded">save</span>
        Отправить остатки
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables
    let products = [];
    let yesterdayStock = {};
    let todaySupplies = {};
    let workingDate = '';
    let currentUser = null;

    // Initialization
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Get user auth first
            const userRes = await fetch('/api/user/me');
            if (userRes.ok) {
                const data = await userRes.json();
                currentUser = data.user;
            } else {
                // Not using session, try Telegram Mini App fallback
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                    const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
                    if (tgUser) {
                        currentUser = { id: tgUser.id, role: 'user' }; // assume fallback
                    }
                }
            }

            if (!currentUser) {
                showToast('Ошибка авторизации. Пожалуйста, войдите в систему.', 'error');
                return;
            }

            // Fetch data concurrently
            await Promise.all([
                checkExistingData(),
                loadProducts(),
                loadYesterdayStock(),
                loadTodaySupplies()
            ]);

            renderTable();
        } catch (e) {
            console.error(e);
            showToast('Возникла ошибка при загрузке данных', 'error');
        }
    });

    async function checkExistingData() {
        try {
            const res = await fetch('/api/stock/check');
            const data = await res.json();
            workingDate = data.working_date;

            const d = new Date(workingDate);
            document.getElementById('currentDate').textContent = d.toLocaleDateString('ru-RU');

            if (data.exists) {
                document.getElementById('existingDataAlert').classList.add('show');
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function loadProducts() {
        const res = await fetch('/api/products');
        products = await res.json();
    }

    async function loadYesterdayStock() {
        try {
            const res = await fetch('/api/stock/yesterday');
            const data = await res.json();
            if (data.stock) {
                data.stock.forEach(item => {
                    yesterdayStock[item.product_id] = item.quantity;
                });
            }
        } catch (e) { console.error('No yesterday stock', e); }
    }

    async function loadTodaySupplies() {
        try {
            const res = await fetch('/api/supplies/today');
            const data = await res.json();
            if (data.supplies) {
                todaySupplies = data.supplies;
            }
        } catch (e) { }
    }

    function renderTable() {
        const tbody = document.getElementById('stockTableBody');
        tbody.innerHTML = '';

        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; py: 32px">Товары не найдены</td></tr>';
            return;
        }

        products.forEach(p => {
            const yest = yesterdayStock[p.id] || 0;
            const supp = todaySupplies[p.id] || 0;
            const expected = yest + supp;
            const expectedDisplay = expected > 0 ? expected.toFixed(1) : '-';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight: 500">${p.name_internal}</div>
                    <div style="font-size: 13px; color: var(--text-tertiary); margin-top: 4px;">
                        ${parseFloat(p.package_weight).toFixed(2)} ${p.unit} × ${p.units_per_box} шт
                    </div>
                </td>
                <td style="text-align: center; font-variant-numeric: tabular-nums;">
                    <span class="badge ${expected > 0 ? 'badge-success' : ''}" style="background: transparent; color: inherit">${expectedDisplay}</span>
                    <span id="mobile-consumption-${p.id}" class="mobile-consumption consumption-zero">-</span>
                </td>
                <td style="text-align: center;">
                    <span id="consumption-${p.id}" class="consumption-zero font-mono">-</span>
                </td>
                <td style="text-align: right; padding-right: 32px;">
                    <input type="number" 
                           id="qty-${p.id}" 
                           class="qty-input" 
                           min="0" step="0.1" value="0" 
                           inputmode="decimal"
                           onfocus="if(this.value=='0') this.value=''"
                           onblur="if(this.value=='') this.value='0'; updateConsumption(${p.id})"
                           oninput="updateConsumption(${p.id})">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateConsumption(productId) {
        const expected = (yesterdayStock[productId] || 0) + (todaySupplies[productId] || 0);
        const current = parseFloat(document.getElementById(`qty-${productId}`).value) || 0;
        const diff = expected - current;

        const ids = [`consumption-${productId}`, `mobile-consumption-${productId}`];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;

            const baseClass = el.classList.contains('mobile-consumption') ? 'mobile-consumption ' : '';

            if (diff > 0) {
                el.textContent = `-${diff.toFixed(1)}`;
                el.className = `${baseClass}consumption-positive`;
            } else if (diff < 0) {
                el.textContent = `+${Math.abs(diff).toFixed(1)}`;
                el.className = `${baseClass}consumption-negative`;
            } else {
                el.textContent = '0';
                el.className = `${baseClass}consumption-zero`;
            }
        });
    }

    async function loadExistingData() {
        try {
            const res = await fetch(`/api/stock/${workingDate}`);
            const existing = await res.json();

            const map = {};
            existing.forEach(i => map[i.product_id] = i.quantity);

            products.forEach(p => {
                const input = document.getElementById(`qty-${p.id}`);
                if (input && map[p.id] !== undefined) {
                    input.value = map[p.id];
                    updateConsumption(p.id);
                }
            });

            document.getElementById('existingDataAlert').classList.remove('show');
            showToast('Данные для редактирования загружены', 'info');
        } catch (e) {
            showToast('Ошибка загрузки данных', 'error');
        }
    }

    async function saveStock() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;

        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="material-symbols-rounded" style="animation: spin 1s linear infinite;">sync</span> Отправка...';

        try {
            const stockData = [];
            products.forEach(p => {
                const qty = parseFloat(document.getElementById(`qty-${p.id}`).value) || 0;
                if (qty > 0) {
                    stockData.push({
                        product_id: p.id,
                        quantity: qty,
                        weight: qty * p.package_weight
                    });
                }
            });

            if (stockData.length === 0) {
                showToast('Укажите количество хотя бы для одного товара', 'warning');
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }

            const payloadParams = {
                date: workingDate,
                stock: stockData,
                user_id: currentUser.id
            };

            // Check if we are inside Telegram Mini App (to pass initData for auth bypass if session fails)
            const headers = { 'Content-Type': 'application/json' };
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
                headers['x-telegram-init-data'] = window.Telegram.WebApp.initData;
            }

            const response = await fetch('/api/stock', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payloadParams)
            });

            const result = await response.json();

            if (result.success) {
                showToast(result.message, 'success');
                // Highlight success and disable inputs temporarily
                document.querySelectorAll('.qty-input').forEach(i => {
                    i.style.borderColor = 'var(--secondary)';
                    i.style.backgroundColor = 'var(--secondary-light)';
                    i.disabled = true;
                });

                setTimeout(() => {
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe.user) {
                        window.Telegram.WebApp.close();
                    } else if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                        window.location.href = '/stock';
                    } else {
                        // Reset forms
                        location.reload();
                    }
                }, 2000);
            } else {
                showToast(result.error || 'Ошибка сохранения', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (e) {
            showToast('Сетевая ошибка', 'error');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
</script>
{% endblock %}