<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–í–≤–æ–¥ –æ—Å—Ç–∞—Ç–∫–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 12px;
            padding-bottom: 80px;
        }

        h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: center;
        }

        .date-info {
            text-align: center;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö */
        .existing-data-alert {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .existing-data-alert.show {
            display: block;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #856404;
        }

        .alert-message {
            font-size: 14px;
            color: #856404;
            margin-bottom: 12px;
        }

        .edit-button {
            width: 100%;
            padding: 10px;
            background-color: #ffc107;
            color: #000;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        .stock-table {
            width: 100%;
        }

        .stock-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 8px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--tg-theme-section-separator-color, #e8e8e8);
        }

        .product-info {
            padding-right: 8px;
        }

        .product-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .product-details {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
        }

        .stock-column {
            text-align: center;
            min-width: 60px;
        }

        .column-label {
            font-size: 10px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .column-value {
            font-size: 14px;
            font-weight: 500;
        }

        .consumption-value {
            font-size: 14px;
            font-weight: 600;
        }

        .consumption-positive {
            color: #dc3545;
        }

        .consumption-negative {
            color: #28a745;
        }

        .consumption-zero {
            color: var(--tg-theme-hint-color, #999);
        }

        .quantity-input {
            width: 70px;
            padding: 8px 6px;
            font-size: 14px;
            border: 1px solid var(--tg-theme-section-separator-color, #e8e8e8);
            border-radius: 8px;
            background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000);
            text-align: center;
        }

        .quantity-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        .save-button {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-section-separator-color, #e8e8e8);
        }

        .save-button button {
            width: 100%;
            padding: 14px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .save-button button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .instruction {
            text-align: center;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 16px;
            font-size: 14px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>–í–≤–æ–¥ –æ—Å—Ç–∞—Ç–∫–æ–≤</h1>
    <div class="date-info" id="dateInfo">–î–∞—Ç–∞: <span id="currentDate"></span></div>
    <div class="instruction">–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–∞–∫–æ–≤–æ–∫</div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö -->
    <div class="existing-data-alert" id="existingDataAlert">
        <div class="alert-title">‚ö†Ô∏è –û—Å—Ç–∞—Ç–∫–∏ —É–∂–µ –≤–Ω–µ—Å–µ–Ω—ã</div>
        <div class="alert-message">
            –û—Å—Ç–∞—Ç–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å —É–∂–µ –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã.<br>
            –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –∑–∞–º–µ—Ç–∏–ª–∏ –æ—à–∏–±–∫—É.
        </div>
        <button class="edit-button" onclick="loadExistingData()">
            ‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É
        </button>
    </div>

    <div class="stock-table" id="stockTable"></div>

    <div class="save-button">
        <button onclick="saveStock()" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let products = [];
        let editMode = false;
        let workingDate = '';
        let yesterdayStock = {};  // –ú–∞–ø–∞ product_id -> quantity –≤—á–µ—Ä–∞—à–Ω–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤
        let yesterdayDate = null;

        // API –±–∞–∑–æ–≤—ã–π URL
        const API_URL = window.location.origin;

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function checkExistingData() {
            try {
                const response = await fetch(`${API_URL}/api/stock/check`);
                const data = await response.json();

                workingDate = data.working_date;
                document.getElementById('currentDate').textContent = formatDate(workingDate);

                if (data.exists) {
                    document.getElementById('existingDataAlert').classList.add('show');
                    editMode = false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function loadExistingData() {
            try {
                console.log(`üîç –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –¥–∞—Ç—É: ${workingDate}`);
                const response = await fetch(`${API_URL}/api/stock/${workingDate}`);
                const existingStock = await response.json();

                console.log(`üì¶ –ü–æ–ª—É—á–µ–Ω–æ ${existingStock.length} –∑–∞–ø–∏—Å–µ–π`);
                if (existingStock.length > 0) {
                    console.log('–ü–µ—Ä–≤—ã–µ 3 –∑–∞–ø–∏—Å–∏:', existingStock.slice(0, 3));
                }

                // –°–æ–∑–¥–∞—ë–º –º–∞–ø—É product_id -> quantity
                const stockMap = {};
                existingStock.forEach(item => {
                    stockMap[item.product_id] = item.quantity;
                });

                console.log(`üó∫Ô∏è –°–æ–∑–¥–∞–Ω–∞ –º–∞–ø–∞ –¥–ª—è ${Object.keys(stockMap).length} —Ç–æ–≤–∞—Ä–æ–≤`);

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Ö–æ–¥
                let filled = 0;
                products.forEach(product => {
                    const input = document.getElementById(`qty-${product.id}`);
                    if (input && stockMap[product.id] !== undefined) {
                        input.value = stockMap[product.id];
                        updateConsumption(product.id);  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Ö–æ–¥
                        filled++;
                    }
                });

                console.log(`‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ ${filled} –ø–æ–ª–µ–π –∏–∑ ${products.length}`);

                // –°–∫—Ä—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç, –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('existingDataAlert').classList.remove('show');
                editMode = true;

                tg.showAlert('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ.');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∑–∞ –≤—á–µ—Ä–∞
        async function loadYesterdayStock() {
            try {
                const response = await fetch(`${API_URL}/api/stock/yesterday`);
                const data = await response.json();

                yesterdayDate = data.date;

                // –°–æ–∑–¥–∞—ë–º –º–∞–ø—É product_id -> quantity
                if (data.stock && data.stock.length > 0) {
                    data.stock.forEach(item => {
                        yesterdayStock[item.product_id] = item.quantity;
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—á–µ—Ä–∞—à–Ω–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤:', error);
                // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É –µ—Å–ª–∏ –≤—á–µ—Ä–∞—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/api/products`);
                products = await response.json();
                renderProducts();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // –ü–µ—Ä–µ—Å—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞
        function updateConsumption(productId) {
            const yesterday = yesterdayStock[productId] || 0;
            const input = document.getElementById(`qty-${productId}`);
            const today = parseFloat(input.value) || 0;

            const consumption = yesterday - today;
            const consumptionEl = document.getElementById(`consumption-${productId}`);

            if (!consumptionEl) return;

            if (consumption > 0) {
                consumptionEl.textContent = `-${consumption.toFixed(1)}`;
                consumptionEl.className = 'consumption-value consumption-positive';
            } else if (consumption < 0) {
                consumptionEl.textContent = `+${Math.abs(consumption).toFixed(1)}`;
                consumptionEl.className = 'consumption-value consumption-negative';
            } else {
                consumptionEl.textContent = '0';
                consumptionEl.className = 'consumption-value consumption-zero';
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
        function renderProducts() {
            const table = document.getElementById('stockTable');
            table.innerHTML = '';

            products.forEach((product, index) => {
                const row = document.createElement('div');
                row.className = 'stock-row';

                const weight = parseFloat(product.package_weight).toFixed(2);
                const yesterday = yesterdayStock[product.id] || 0;
                const yesterdayDisplay = yesterday > 0 ? yesterday.toFixed(1) : '-';

                row.innerHTML = `
                    <div class="product-info">
                        <div class="product-name">${product.name_internal}</div>
                        <div class="product-details">
                            ${weight} ${product.unit} √ó ${product.units_per_box} —É–ø.
                        </div>
                    </div>
                    <div class="stock-column">
                        <div class="column-label">–í—á–µ—Ä–∞</div>
                        <div class="column-value">${yesterdayDisplay}</div>
                    </div>
                    <div class="stock-column">
                        <div class="column-label">–†–∞—Å—Ö–æ–¥</div>
                        <div class="consumption-value consumption-zero" id="consumption-${product.id}">-</div>
                    </div>
                    <div class="stock-column">
                        <input
                            type="number"
                            class="quantity-input"
                            id="qty-${product.id}"
                            min="0"
                            step="0.5"
                            value="0"
                            inputmode="decimal"
                            placeholder="—É–ø."
                            oninput="updateConsumption(${product.id})"
                        >
                    </div>
                `;
                table.appendChild(row);
            });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
        async function saveStock() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            try {
                const stockData = [];

                products.forEach(product => {
                    const input = document.getElementById(`qty-${product.id}`);
                    const quantity = parseFloat(input.value) || 0;

                    if (quantity > 0) {
                        const weight = quantity * product.package_weight;
                        stockData.push({
                            product_id: product.id,
                            quantity: quantity,
                            weight: weight
                        });
                    }
                });

                if (stockData.length === 0) {
                    tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä');
                    saveBtn.disabled = false;
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    return;
                }

                const response = await fetch(`${API_URL}/api/stock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: workingDate,
                        stock: stockData,
                        user_id: tg.initDataUnsafe?.user?.id || 'unknown'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    tg.showAlert(result.message, () => {
                        tg.close();
                    });
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    saveBtn.disabled = false;
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
                saveBtn.disabled = false;
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await checkExistingData();
            await loadYesterdayStock();  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—á–µ—Ä–∞—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
            await loadProducts();
        }

        init();
    </script>
</body>
</html>
