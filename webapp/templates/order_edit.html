<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 12px;
            padding-bottom: 80px;
        }

        h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .order-info {
            text-align: center;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .total-cost {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .total-cost-label {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 4px;
        }

        .total-cost-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--tg-theme-text-color);
        }

        .order-items {
            margin-bottom: 20px;
        }

        .order-item {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .item-name {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            padding-right: 12px;
        }

        .item-status {
            font-size: 20px;
        }

        .item-details {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .item-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .quantity-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.1s, opacity 0.2s;
        }

        .quantity-btn:active {
            transform: scale(0.95);
        }

        .quantity-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .quantity-display {
            flex: 1;
            text-align: center;
        }

        .quantity-value {
            font-size: 20px;
            font-weight: 700;
            display: block;
        }

        .quantity-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
        }

        .delete-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background-color: #ff3b30;
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.1s;
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        .item-cost {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--tg-theme-section-separator-color, #e8e8e8);
            text-align: right;
            font-size: 16px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--tg-theme-hint-color, #999);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }

        .removing {
            animation: fadeOut 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <h1>üõí –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
    <div class="order-info" id="orderInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="total-cost">
        <div class="total-cost-label">–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞</div>
        <div class="total-cost-value" id="totalCost">0‚Ç∏</div>
    </div>

    <div id="content">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–∞...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.enableClosingConfirmation();

        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω —É–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
        if (tg.MainButton) {
            tg.MainButton.hideProgress();
        }

        let orderData = {
            products: [],
            order_days: 14
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
        async function loadOrder() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ initData (—Ç–∞–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å order_id –∏–ª–∏ –≤–µ—Å—å –∑–∞–∫–∞–∑)
                const initData = tg.initData;
                const urlParams = new URLSearchParams(window.location.search);
                const startParam = urlParams.get('tgWebAppStartParam');

                // –î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ start_parameter –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ WebApp
                // –§–æ—Ä–º–∞—Ç: draft_UUID (–Ω–æ–≤—ã–π) –∏–ª–∏ order_DATA_BASE64 (—Å—Ç–∞—Ä—ã–π, –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                if (startParam && startParam.startsWith('draft_')) {
                    // –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–±: –∑–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ API
                    const draftKey = startParam.substring(6);
                    console.log('Loading draft order via API:', draftKey);

                    const apiUrl = `${window.location.origin}/api/draft_order/${draftKey}`;
                    console.log('API URL:', apiUrl);

                    const response = await fetch(apiUrl);
                    console.log('API response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error:', errorText);
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞');
                    }
                    orderData = await response.json();
                    console.log('Order data loaded:', orderData);
                } else if (startParam && startParam.startsWith('order_')) {
                    // –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±: –ø–∞—Ä—Å–∏–º –∏–∑ URL (fallback –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                    const base64Data = startParam.substring(6);
                    let orderJson;
                    try {
                        orderJson = atob(base64Data);
                        console.log('Decoded JSON:', orderJson.substring(0, 200));
                    } catch (e) {
                        console.error('Base64 decode error:', e);
                        throw new Error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
                    }

                    try {
                        orderData = JSON.parse(orderJson);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        console.error('JSON string:', orderJson);
                        throw new Error('JSON Parse error: ' + e.message);
                    }
                } else {
                    throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞');
                }

                document.getElementById('orderInfo').textContent =
                    `–ó–∞–∫–∞–∑ –Ω–∞ ${orderData.order_days} –¥–Ω–µ–π ‚Ä¢ ${orderData.products.length} –ø–æ–∑–∏—Ü–∏–π`;

                renderOrder();
                updateTotal();
                setupMainButton();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞:', error);
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <div class="empty-state-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞<br>${error.message}</div>
                    </div>
                `;
            }
        }

        function renderOrder() {
            const content = document.getElementById('content');

            if (orderData.products.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-text">–ó–∞–∫–∞–∑ –ø—É—Å—Ç<br>–í—Å–µ —Ç–æ–≤–∞—Ä—ã —É–¥–∞–ª–µ–Ω—ã</div>
                    </div>
                `;
                return;
            }

            const itemsHtml = orderData.products.map((product, index) => {
                const urgencyIcon = product.urgency === '–°–†–û–ß–ù–û' ? 'üö®' : '‚ö†Ô∏è';
                const unit = product.unit || '–∫–≥';
                const pendingInfo = product.pending_weight > 0
                    ? ` + ${product.pending_weight.toFixed(1)} ${unit} –≤ –ø—É—Ç–∏`
                    : '';

                return `
                    <div class="order-item" id="item-${index}">
                        <div class="item-header">
                            <div class="item-name">${product.name_russian}</div>
                            <div class="item-status">${urgencyIcon}</div>
                        </div>
                        <div class="item-details">
                            –û—Å—Ç–∞—Ç–æ–∫: ${product.current_stock.toFixed(1)} ${unit}${pendingInfo}<br>
                            –†–∞—Å—Ö–æ–¥: ${product.avg_daily_consumption.toFixed(1)} ${unit}/–¥–µ–Ω—å<br>
                            –•–≤–∞—Ç–∏—Ç –Ω–∞: ${product.days_left} –¥–Ω.
                        </div>
                        <div class="item-controls">
                            <div class="quantity-control">
                                <button class="quantity-btn" onclick="decreaseQuantity(${index})" ${product.boxes_to_order <= 1 ? 'disabled' : ''}>‚àí</button>
                                <div class="quantity-display">
                                    <span class="quantity-value" id="qty-${index}">${product.boxes_to_order}</span>
                                    <span class="quantity-label">–∫–æ—Ä–æ–±–æ–∫</span>
                                </div>
                                <button class="quantity-btn" onclick="increaseQuantity(${index})">+</button>
                            </div>
                            <button class="delete-btn" onclick="deleteItem(${index})">üóë</button>
                        </div>
                        <div class="item-cost" id="cost-${index}">${formatCost(product.order_cost)}</div>
                    </div>
                `;
            }).join('');

            content.innerHTML = `<div class="order-items">${itemsHtml}</div>`;
        }

        function decreaseQuantity(index) {
            if (orderData.products[index].boxes_to_order > 1) {
                orderData.products[index].boxes_to_order--;
                updateProduct(index);
            }
        }

        function increaseQuantity(index) {
            orderData.products[index].boxes_to_order++;
            updateProduct(index);
        }

        function deleteItem(index) {
            const item = document.getElementById(`item-${index}`);
            item.classList.add('removing');

            setTimeout(() => {
                orderData.products.splice(index, 1);
                renderOrder();
                updateTotal();

                if (orderData.products.length === 0) {
                    tg.MainButton.setParams({
                        text: '–ó–∞–∫–∞–∑ –ø—É—Å—Ç',
                        is_active: false
                    });
                }
            }, 300);
        }

        function updateProduct(index) {
            const product = orderData.products[index];
            product.needed_weight = product.boxes_to_order * product.box_weight;
            product.order_cost = product.boxes_to_order * product.price_per_box;

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById(`qty-${index}`).textContent = product.boxes_to_order;
            document.getElementById(`cost-${index}`).textContent = formatCost(product.order_cost);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–º–µ–Ω—å—à–µ–Ω–∏—è
            const decreaseBtn = document.querySelectorAll('.quantity-btn')[index * 2];
            decreaseBtn.disabled = product.boxes_to_order <= 1;

            updateTotal();
        }

        function updateTotal() {
            const total = orderData.products.reduce((sum, p) => sum + p.order_cost, 0);
            document.getElementById('totalCost').textContent = formatCost(total);
        }

        function formatCost(cost) {
            return cost.toLocaleString('ru-RU') + '‚Ç∏';
        }

        function setupMainButton() {
            console.log('Setting up main button, products count:', orderData.products.length);
            try {
                tg.MainButton.setParams({
                    text: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫–∞–∑',
                    color: tg.themeParams.button_color || '#3390ec',
                    is_active: orderData.products.length > 0,
                    is_visible: true
                });

                tg.MainButton.onClick(saveOrder);
                console.log('Main button setup complete');
            } catch (e) {
                console.error('Error setting up main button:', e);
            }
        }

        function saveOrder() {
            tg.MainButton.showProgress();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç–∞
            tg.sendData(JSON.stringify({
                action: 'save_order',
                products: orderData.products,
                order_days: orderData.order_days
            }));
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        loadOrder();
    </script>
</body>
</html>
