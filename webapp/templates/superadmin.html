{% extends "layout.html" %}

{% block content %}
<div class="superadmin-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Центр управления франшизами</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newCompanyModal">
            <i class="fas fa-plus"></i> Новая компания
        </button>
    </div>

    <!-- Общая статистика -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3 mb-md-0">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Всего компаний</h5>
                    <h2 class="display-4">{{ total_companies }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Активные</h5>
                    <h2 class="display-4">{{ active_companies }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Всего пользователей</h5>
                    <h2 class="display-4">{{ total_users }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица компаний -->
    <div class="card">
        <div class="card-header bg-white">
            <h5 class="mb-0">Зарегистрированные компании</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Название</th>
                            <th>Статус подписки</th>
                            <th>До (Дата)</th>
                            <th>Сотрудников</th>
                            <th>Владелец</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for company in companies %}
                        <tr>
                            <td>{{ company.id }}</td>
                            <td class="fw-bold">{{ company.name }}</td>
                            <td>
                                {% if company.subscription_status == 'active' %}
                                <span class="badge bg-success">Активна</span>
                                {% elif company.subscription_status == 'trial' %}
                                <span class="badge bg-warning text-dark">Trial</span>
                                {% else %}
                                <span class="badge bg-danger">Заблокирована</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if company.subscription_ends_at %}
                                {{ company.subscription_ends_at.strftime('%d.%m.%Y') }}
                                {% else %}
                                <span class="text-muted">Неограниченно</span>
                                {% endif %}
                            </td>
                            <td>{{ company.user_count }}</td>
                            <td>
                                {% if company.owner_username %}
                                @{{ company.owner_username }}
                                {% else %}
                                <span class="text-muted">Нет</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" title="Настройки"
                                        onclick="alert('TODO: Настройки (управление подпиской)')">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button class="btn btn-outline-info" title="Сгенерировать инвайт для владельца"
                                        onclick="generateInvite({{ company.id }}, 'admin')">
                                        <i class="fas fa-link"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">
                                Нет зарегистрированных компаний (Кроме системной)
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно "Новая компания" -->
<div class="modal fade" id="newCompanyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создать новую компанию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newCompanyForm">
                    <div class="mb-3">
                        <label for="companyName" class="form-label">Название компании (ИП / Точка)</label>
                        <input type="text" class="form-control" id="companyName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="btnCreateCompany">Создать и получить ссылку</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно с Инвайт-ссылкой -->
<div class="modal fade" id="inviteLinkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Приглашение сгенерировано</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>Отправьте эту ссылку <b>Владельцу (Управляющему)</b> новой точки. После перехода по ней он навсегда
                    привяжется к этой компании с правами `admin`.</p>
                <div class="input-group mb-3 mt-4">
                    <input type="text" class="form-control" id="inviteLinkInput" readonly>
                    <button class="btn btn-outline-secondary" type="button" onclick="copyInviteLink()">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div id="copySuccessMsg" class="text-success d-none mt-2">Ссылка скопирована в буфер обмена!</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="window.location.reload()">Готово</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.getElementById('btnCreateCompany').addEventListener('click', async function () {
        const name = document.getElementById('companyName').value;

        if (!name) {
            alert('Введите название компании');
            return;
        }

        const btn = this;
        btn.disabled = true;

        try {
            const response = await fetch('/api/superadmin/companies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // Прячем старое модальное окно (чистым JS или jQuery если есть)
                const newCompanyModalEl = document.getElementById('newCompanyModal');
                const newCompanyModal = bootstrap.Modal.getInstance(newCompanyModalEl);
                if (newCompanyModal) {
                    newCompanyModal.hide();
                } else {
                    // Fallback (jQuery)
                    $('#newCompanyModal').modal('hide');
                }

                // Показываем новое окно с инвайтом
                document.getElementById('inviteLinkInput').value = data.invite_url;

                const inviteLinkModalEl = document.getElementById('inviteLinkModal');
                const inviteLinkModal = bootstrap.Modal.getInstance(inviteLinkModalEl);
                if (inviteLinkModal) {
                    inviteLinkModal.show();
                } else {
                    // Fallback
                    $('#inviteLinkModal').modal('show');
                }

            } else {
                alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                btn.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Сетевая ошибка при создании компании');
            btn.disabled = false;
        }
    });

    function copyInviteLink() {
        const copyText = document.getElementById("inviteLinkInput");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);

        const successMsg = document.getElementById('copySuccessMsg');
        successMsg.classList.remove('d-none');
        setTimeout(() => successMsg.classList.add('d-none'), 2000);
    }

    function generateInvite(companyId, role) {
        alert('Функция генерации инвайта для существующей компании в разработке.');
    }
</script>
{% endblock %}