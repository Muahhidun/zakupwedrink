"""
–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–∏—Ç–∞–π—Å–∫–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
"""
import asyncio
import os
from dotenv import load_dotenv
from database_pg import DatabasePG

load_dotenv()

# –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–∏—Ç–∞–π—Å–∫–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏
chinese_products = {
    "–ú–∞–Ω–≥–æ–≤–æ–µ –ø—é—Ä–µ 1,2 –∫–≥": "ËäíÊûúÈ¢óÁ≤íÊûúÈÖ±",
    "–ü–µ—Ä—Å–∏–∫–æ–≤–æ–µ –ø—é—Ä–µ 1,2 –∫–≥": "Á≤âÊ°ÉÈÖ±",
    "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –Ω–∞–ø–∏—Ç–∫–∞ —Å –∫—É—Å–æ—á–∫–∞–º–∏ –∞–ø–µ–ª—å—Å–∏–Ω–∞ 2,6 –∫–≥": "È¶ôÊ©ôÊ±Å",
    "–ú–∞–ª–∏–Ω–∞ —Å–æ–∫ 2,6 –∫–≥": "Ê†ëËéìÊ±Å",
    "–í–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π —Å–æ–∫ 2,6 –∫–≥": "Ëë°ËêÑÂ§çÂêàÊûúÊ±Å",
    "–í–∏–Ω–æ–≥—Ä–∞–¥ –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 850 –≥": "Á≥ñÊ∞¥Ëë°ËêÑÁΩêÂ§¥",
    "–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç 850 –≥": "Ë•øÊüöÈ¢óÁ≤í",
    "–õ–∞—Ç—Ç–µ 1 –∫–≥": "ÊãøÈìÅ",
    "–Ø–Ω—á–∂–∏ –ì–∞–Ω–ª—É 1 –∫–≥": "Êù®ÊûùÁîòÈú≤Á≤â",
    "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç —Å–æ–∫–∞ –º–∞—Ä–∞–∫—É–π–∏ 2 –∫–≥": "ÁôæÈ¶ôÊûú",
    "–°–∏—Ä–æ–ø –∏–∑ —Ñ—Ä—É–∫—Ç–æ–≤–æ–≥–æ —Å–æ–∫–∞ 12,5 –∫–≥": "ÊûúÁ≥ñ",
    "–ö–æ–∫–æ—Å–æ–≤—ã–µ –∫—É—Å–æ—á–∫–∏ 2,5 –∫–≥": "Ê§∞Êûú",
    "–¢–∞–ø–∏–æ–∫–∞ 1 –∫–≥": "ÈªëÁèçÁè†",
    "–•—Ä—É—Å—Ç—è—â–∏–µ —Ä–æ–∂–∫–∏ –ø–æ 400 —à—Ç—É–∫": "Êñ∞ÂûãÈïøËÑÜÁ≠í",
    "–ü–æ—Ä–æ—à–æ–∫ —Å–æ –≤–∫—É—Å–æ–º –º–æ–ª–æ—á–Ω–æ–≥–æ –∫–æ–∫—Ç–µ–π–ª—è (—Å–ª–∏–≤–æ—á–Ω—ã–π)  3–∫–≥": "ÂéüÂë≥ÂÜ∞Ê∑áÊ∑ãÁ≤â",
    "–ü–æ—Ä–æ—à–æ–∫ —Å–æ –≤–∫—É—Å–æ–º –º–æ–ª–æ—á–Ω–æ–≥–æ –∫–æ–∫—Ç–µ–π–ª—è ( —à–æ–∫–æ–ª–∞–¥–Ω—ã–π) 3–∫–≥": "ÂéüÂë≥ÂÜ∞Ê∑áÊ∑ãÁ≤â",  # –ù–µ—Ç –≤ –ë–î!
    "–ö–æ–º–ø–∞–Ω—å–æ–Ω –¥–ª—è —á–∞—è —Å –º–æ–ª–æ–∫–æ–º 3 –∫–≥": "Â•∂Ëå∂‰º¥‰æ£",
    "–§—Ä—É—Ç–æ–≤—ã–π –º–µ–¥ 5.5–∫–≥": "ÊûúËúú",
    "–ü–æ—Ä–æ—à–æ–∫ –¥–ª—è –∫–∞—Ä–∞–º–µ–ª—å–Ω–æ–≥–æ –ø—É–¥–∏–Ω–≥–∞ 1 –∫–≥": "Â∏É‰∏ÅÁ≤â",
    "–ß–µ—Ä–Ω—ã–π —Å–∞—Ö–∞—Ä 2,5 –∫–≥": "ÈªëÁ≥ñÁ≥ñÊµÜ",
    "–®–æ–∫–æ–ª–∞–¥–Ω—ã–π —Å–∏—Ä–æ–ø 2,5 –∫–≥": "Â∑ßÂÖãÂäõÊµÜ",
    "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –∫–ª—É–±–Ω–∏—á–Ω–æ–≥–æ —Å–æ–∫–∞ 2 –∫–≥": "ËçâËéìÊûúÊµÜ",
    "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –Ω–∞–ø–∏—Ç–∫–∞ —Å –∫—É—Å–æ—á–∫–∞–º–∏ —á–µ—Ä–Ω–∏–∫–∏ 2 –∫–≥": "ËìùËéìÊûúÊµÜ",
    "–ü–µ—Ä—Å–∏–∫–æ–≤–æ–µ –∂–µ–ª–µ 1 –ª": "ËúúÊ°ÉÂÜª",
    "–§–∞—Å–æ–ª—å 900 –≥": "Á∫¢Ë±ÜÁΩêÂ§¥",
    "–ö–∞–ø–ø—É—á–∏–Ω–æ –ø–æ—Ä–æ—à–æ–∫": "Âç°Â∏ÉÂ•áËØ∫",
    "–ú–∞—Ç—á–∞ –º–æ—Ä–æ–∂–µ–Ω–æ–µ": "ÊäπËå∂ÂÜ∞Ê∑áÊ∑ãÁ≤â",
    "–û—Ä–µ–æ –∫—Ä–æ—à–∫–∞ –¥–ª—è —Ç–æ–ø–∏–Ω–≥–∞": "Â••Âà©Â••Á¢éÂ±ë",
    "–ñ–∞—Å–º–∏–Ω–æ–≤—ã–π —á–∞–π": "Ëåâ‰∏äÈùíÈ£é",
    "–ß–µ—Ä–Ω—ã–π —á–∞–π": "Ê¢ÖÂç†Á∫¢Ëå∂",
    "–°—Ç–∞–∫–∞–Ω 500": "WE.500-90Â°ëÊùØ",
    "–°—Ç–∞–∫–∞–Ω 700": "WE.700-90Â°ëÊùØ",
    "–°—Ç–∞–∫–∞–Ω–∞ –±–æ–ª—å—à–æ–π 900–º–ª": "Âê®Âê®Ê°∂ÔºàÊñ∞Ôºâ",
    "–°—Ç–∞–∫–∞–Ω U": "UÂûãÊùØ",
    "–¢–æ–ª—Å—Ç—ã–µ –±—É–º–∞–∂–Ω—ã–µ —Ç—Ä—É–±–æ—á–∫–∏": "Á∫∏ËÜúÁ≤óÂê∏ÁÆ°",
    "–¢–æ–Ω–∫–∏–µ –±—É–º–∞–∂–Ω—ã–µ —Ç—Ä—É–±–æ—á–∫–∏": "Á∫∏ËÜúÁªÜÂê∏ÁÆ°",
    "–ö—Ä—ã—à–∫–∞ –∫—É–ø–æ–ª—å–Ω–∞—è 90": "WE. ÁêÉÂΩ¢ÁõñÔºà90Ôºâ",
    "–±–æ–ª—å—à–∞—è –¥–ª–∏–Ω–Ω–∞—è –ª–æ–∂–∫–∞": "WE.Â§ßÈïøÂã∫",
    "–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–∂–∫–∞ (–º–∞–ª–µ–Ω—å–∫–∞—è, –¥–µ–≥—É—Å—Ç–∞—Ü–∏–æ–Ω–Ω–∞—è)": "WE.‰∏ìÁî®Âã∫",
    "–ü–ª—ë–Ω–∫–∞ –¥–ª—è –∑–∞–ø–∞–π–∫–∏ —Å—Ç–∞–∫–∞–Ω–æ–≤": "WE.Â∞ÅÂè£ËÜú",
    "–ü–∞–∫–µ—Ç –¥–ª—è –æ–¥–Ω–æ–π —á–∞—à–∫–∏": "WE.ÂçïÊùØË¢ã",
    "–ü–∞–∫–µ—Ç –¥–ª—è –¥–≤—É—Ö —á–∞—à–µ–∫": "WE.ÂèåÊùØË¢ã",
    "–ü–∞–∫–µ—Ç –¥–ª—è —á–µ—Ç—ã—Ä—ë—Ö —á–∞—à–µ–∫": "ÂõõÊùØË¢ã",
    "–ë—É–º–∞–∂–Ω—ã–π —Å—Ç–∞–∫–∞–Ω": "16A‰∏≠Á©∫Á∫∏ÊùØ",
    "–ö—Ä—ã—à–∫–∞ 90 –ø–ª–∞—Å—Ç–∏–∫ –¥–ª—è –±—É–º–∞–∂–Ω–æ–≥–æ —Å—Ç–∞–∫–∞–Ω–∞": "90Ê≥®Â°ëÈò≤ÊºèËøû‰ΩìÁõñ-Èªë",
}

async def main():
    database_url = os.getenv('DATABASE_URL')
    db = DatabasePG(database_url)
    await db.init_db()

    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –ë–î
        products = await db.get_all_products()
        existing_names = {p['name_russian'] for p in products}

        print("=" * 100)
        print("üîç –ü–†–û–í–ï–†–ö–ê –¢–û–í–ê–†–û–í –ò–ó –ö–ò–¢–ê–ô–°–ö–û–ô –ù–ê–ö–õ–ê–î–ù–û–ô")
        print("=" * 100)

        missing = []
        found = []

        for russian_name, chinese_name in chinese_products.items():
            if russian_name in existing_names:
                found.append(russian_name)
            else:
                missing.append((russian_name, chinese_name))

        print(f"\n‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤ –ë–î: {len(found)}/{len(chinese_products)}")
        print(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ë–î: {len(missing)}\n")

        if missing:
            print("=" * 100)
            print("üìã –¢–û–í–ê–†–´, –ö–û–¢–û–†–´–ï –ù–£–ñ–ù–û –î–û–ë–ê–í–ò–¢–¨ –í –ë–î:")
            print("=" * 100)
            for i, (rus, chi) in enumerate(missing, 1):
                print(f"{i}. {rus}")
                print(f"   ({chi})")
                print("-" * 100)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ—Å—Ç–∞–≤–æ–∫
        print("\n" + "=" * 100)
        print("üîç –ü–†–û–í–ï–†–ö–ê –î–£–ë–õ–ò–ö–ê–¢–û–í –ü–û–°–¢–ê–í–û–ö")
        print("=" * 100)

        async with db.pool.acquire() as conn:
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∏ —Ç–æ–≤–∞—Ä—É
            duplicates = await conn.fetch("""
                SELECT
                    date,
                    product_id,
                    COUNT(*) as count,
                    ARRAY_AGG(id ORDER BY id) as ids
                FROM supplies
                GROUP BY date, product_id
                HAVING COUNT(*) > 1
                ORDER BY date DESC
            """)

            if duplicates:
                print(f"\n‚ùå –ù–∞–π–¥–µ–Ω–æ {len(duplicates)} –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π:\n")

                total_duplicates = 0
                for dup in duplicates:
                    product = await conn.fetchrow(
                        "SELECT name_russian FROM products WHERE id = $1",
                        dup['product_id']
                    )
                    print(f"üìÖ {dup['date'].strftime('%d.%m.%Y')} - {product['name_russian']}")
                    print(f"   –ü–æ–≤—Ç–æ—Ä–æ–≤: {dup['count']} (IDs: {dup['ids']})")
                    print(f"   ‚ûú –ù—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å {dup['count'] - 1} –∑–∞–ø–∏—Å–µ–π")
                    total_duplicates += (dup['count'] - 1)

                print(f"\nüí° –í—Å–µ–≥–æ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å {total_duplicates} –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π")
            else:
                print("\n‚úÖ –î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

    finally:
        await db.close()

if __name__ == '__main__':
    asyncio.run(main())
