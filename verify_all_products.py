"""
–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–î:
- –í—Å–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- –í—Å–µ —Ü–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- –ù–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã
"""
import asyncio
import os
import sys

sys.path.insert(0, os.path.dirname(__file__))
from database_pg import DatabasePG

# –û–∂–∏–¥–∞–µ–º—ã–µ —Ü–µ–Ω—ã (name_internal -> price_per_box)
EXPECTED_PRICES = {
    "–ö–æ–∫–æ—Å–æ–≤—ã–µ –∫—É—Å–æ—á–∫–∏ 2.5–∫–≥*8—à—Ç": 15500.0,
    "–¢–∞–ø–∏–æ–∫–∞ 1–∫–≥*20—à—Ç": 25000.0,
    "–ê–ø–µ–ª—å—Å–∏–Ω–æ–≤—ã–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç 2.6–∫–≥*8—à—Ç": 50000.0,
    "–í–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π —Å–æ–∫ 2.6–∫–≥*8—à—Ç": 45000.0,
    "–õ–æ–∂–∫–∞ –±–æ–ª—å—à–∞—è (—á–µ—Ä–Ω–∞—è) (2000—à—Ç/–∫–æ—Ä)": 30000.0,
    "–•—Ä—É—Å—Ç—è—â–∏–µ —Ä–æ–∂–∫–∏ 400—à—Ç": 10937.5,
    "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ (—à–æ–∫–æ–ª–∞–¥–Ω–æ–µ) 3–∫–≥*8—à—Ç": 71250.0,
    "–õ–æ–∂–∫–∞ –º–∞–ª–µ–Ω—å–∫–∞—è (–±–µ–ª–∞—è) (1000—à—Ç/–∫–æ—Ä)": 8400.0,
    # –ù–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    "–ñ–µ–ª–µ —à–∞—Ä—ã 1–∫–≥*20—à—Ç": 25000.0,
    "–ö–æ—Ñ–µ –∑–µ—Ä–Ω–∞ 500–≥*20—à—Ç": 115000.0,
    "–ü–æ—Ä–æ—à–æ–∫ –¥–ª—è –≤–∞—Ñ–µ–ª—å 1.5–∫–≥*8—à—Ç": 22000.0,
    "–ö–æ–∫–æ—Å–æ–≤–æ–µ –º–æ–ª–æ–∫–æ 1–ª*12—à—Ç": 13500.0,
}

# –ù–∞–∑–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π)
EXPECTED_NAMES = [
    "–õ–∞—Ç—Ç–µ 1–∫–≥*20—à—Ç",
    "–Ø–Ω—á–∂–∏ –ì–∞–Ω–ª—É 1–∫–≥*20—à—Ç",
    "–ú–∞—Ä–∞–∫—É–π—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç 2–∫–≥*6—à—Ç",
    "–°–∏—Ä–æ–ø —Ñ—Ä—É–∫—Ç–æ–≤—ã–π 12.5–∫–≥*2—à—Ç",
    "–ö–æ–∫–æ—Å–æ–≤—ã–µ –∫—É—Å–æ—á–∫–∏ 2.5–∫–≥*8—à—Ç",
    "–¢–∞–ø–∏–æ–∫–∞ 1–∫–≥*20—à—Ç",
    "–•—Ä—É—Å—Ç—è—â–∏–µ —Ä–æ–∂–∫–∏ 400—à—Ç",
    "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ (—Å–ª–∏–≤–æ—á–Ω–æ–µ) 3–∫–≥*8—à—Ç",
    "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ (—à–æ–∫–æ–ª–∞–¥–Ω–æ–µ) 3–∫–≥*8—à—Ç",
    "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ (–º–∞—Ç—á–∞) 3–∫–≥*8—à—Ç",
    "–ö–æ–º–ø–∞–Ω—å–æ–Ω –¥–ª—è —á–∞—è 3–∫–≥*8—à—Ç",
    "–§—Ä—É–∫—Ç–æ–≤—ã–π –º–µ–¥ 5.5–∫–≥*4—à—Ç",
    "–ü–æ—Ä–æ—à–æ–∫ –¥–ª—è –ø—É–¥–∏–Ω–≥–∞ 1–∫–≥*20—à—Ç",
    "–ß–µ—Ä–Ω—ã–π —Å–∞—Ö–∞—Ä 2.5–∫–≥*8—à—Ç",
    "–®–æ–∫–æ–ª–∞–¥–Ω—ã–π —Å–∏—Ä–æ–ø 2.5–∫–≥*8—à—Ç",
    "–ö–ª—É–±–Ω–∏—á–Ω—ã–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç 2–∫–≥*6—à—Ç",
    "–ß–µ—Ä–Ω–∏—á–Ω—ã–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç 2–∫–≥*6—à—Ç",
    "–ü–µ—Ä—Å–∏–∫–æ–≤–æ–µ –∂–µ–ª–µ 1–ª*10—à—Ç",
    "–§–∞—Å–æ–ª—å 0.9–∫–≥*12—à—Ç",
    "–ö–∞–ø–ø—É—á–∏–Ω–æ 1–∫–≥*20—à—Ç",
    "–ñ–∞—Å–º–∏–Ω–æ–≤—ã–π —á–∞–π 50–≥*160—à—Ç",
    "–ß–µ—Ä–Ω—ã–π —á–∞–π 100–≥*120—à—Ç",
    "–°—Ç–∞–∫–∞–Ω 500 (1000—à—Ç/–∫–æ—Ä)",
    "–°—Ç–∞–∫–∞–Ω 700 (1000—à—Ç/–∫–æ—Ä)",
    "–°—Ç–∞–∫–∞–Ω –±–æ–ª—å—à–æ–π 900–º–ª (200—à—Ç/–∫–æ—Ä)",
    "–°—Ç–∞–∫–∞–Ω U (1000—à—Ç/–∫–æ—Ä)",
    "–¢–æ–ª—Å—Ç—ã–µ —Ç—Ä—É–±–æ—á–∫–∏ (4000—à—Ç/–∫–æ—Ä)",
    "–¢–æ–Ω–∫–∏–µ —Ç—Ä—É–±–æ—á–∫–∏ (5000—à—Ç/–∫–æ—Ä)",
    "–ö—Ä—ã—à–∫–∞ –∫—É–ø–æ–ª—å–Ω–∞—è (2000—à—Ç/–∫–æ—Ä)",
    "–õ–æ–∂–∫–∞ –±–æ–ª—å—à–∞—è (—á–µ—Ä–Ω–∞—è) (2000—à—Ç/–∫–æ—Ä)",
    "–õ–æ–∂–∫–∞ –º–∞–ª–µ–Ω—å–∫–∞—è (–±–µ–ª–∞—è) (1000—à—Ç/–∫–æ—Ä)",
    "–ü–ª—ë–Ω–∫–∞ –¥–ª—è –∑–∞–ø–∞–π–∫–∏ (12—Ä—É–ª/–∫–æ—Ä)",
    "–ü–∞–∫–µ—Ç 1 —á–∞—à–∫–∞ (10000—à—Ç/–∫–æ—Ä)",
    "–ü–∞–∫–µ—Ç 4 —á–∞—à–∫–∏ (3000—à—Ç/–∫–æ—Ä)",
    "–ë—É–º–∞–∂–Ω—ã–π —Å—Ç–∞–∫–∞–Ω (500—à—Ç/–∫–æ—Ä)",
    "–ö—Ä—ã—à–∫–∞ 90 –ø–ª–∞—Å—Ç–∏–∫ (1000—à—Ç/–∫–æ—Ä)",
    # –ù–æ–≤—ã–µ
    "–ñ–µ–ª–µ —à–∞—Ä—ã 1–∫–≥*20—à—Ç",
    "–ö–æ—Ñ–µ –∑–µ—Ä–Ω–∞ 500–≥*20—à—Ç",
    "–ü–æ—Ä–æ—à–æ–∫ –¥–ª—è –≤–∞—Ñ–µ–ª—å 1.5–∫–≥*8—à—Ç",
    "–ö–æ–∫–æ—Å–æ–≤–æ–µ –º–æ–ª–æ–∫–æ 1–ª*12—à—Ç",
]

# –°—Ç–∞—Ä—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å
OLD_NAMES_SHOULD_NOT_EXIST = [
    "–õ–∞—Ç—Ç–µ 1 –∫–≥",
    "–Ø–Ω—á–∂–∏ –ì–∞–Ω–ª—É 1 –∫–≥",
    "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç —Å–æ–∫–∞ –º–∞—Ä–∞–∫—É–π–∏ 2 –∫–≥",
    "–°–∏—Ä–æ–ø –∏–∑ —Ñ—Ä—É–∫—Ç–æ–≤–æ–≥–æ —Å–æ–∫–∞ 12,5 –∫–≥",
    "–ö–æ–∫–æ—Å–æ–≤—ã–µ –∫—É—Å–æ—á–∫–∏ 2,5 –∫–≥",
    "–¢–∞–ø–∏–æ–∫–∞ 1 –∫–≥",
    "–•—Ä—É—Å—Ç—è—â–∏–µ —Ä–æ–∂–∫–∏ –ø–æ 400 —à—Ç—É–∫",
    "–°—Ç–∞–∫–∞–Ω–∞ –±–æ–ª—å—à–æ–π 900–º–ª",
    "–°—Ç–∞–∫–∞–Ω –±–æ–ª—å—à–æ–π 900–º–ª",  # –±–µ–∑ (200—à—Ç/–∫–æ—Ä)
    "–±–æ–ª—å—à–∞—è –¥–ª–∏–Ω–Ω–∞—è –ª–æ–∂–∫–∞",
    "–û—Ä–µ–æ –∫—Ä–æ—à–∫–∞",
]


async def main():
    database_url = os.environ.get("DATABASE_URL")
    if not database_url:
        print("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ DATABASE_URL")
        return

    db = DatabasePG(database_url)
    await db.init_db()

    products = await db.get_all_products()
    product_map = {p["name_internal"]: p for p in products}

    errors = 0
    warnings = 0

    print("=" * 60)
    print("–ü–†–û–í–ï–†–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•")
    print("=" * 60)

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π
    print("\nüìã 1. –ü–†–û–í–ï–†–ö–ê –ù–ê–ó–í–ê–ù–ò–ô")
    for name in EXPECTED_NAMES:
        if name in product_map:
            print(f"  ‚úÖ {name}")
        else:
            print(f"  ‚ùå –ù–ï –ù–ê–ô–î–ï–ù: {name}")
            errors += 1

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π (–Ω–µ –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
    print("\nüóëÔ∏è  2. –°–¢–ê–†–´–ï –ù–ê–ó–í–ê–ù–ò–Ø (–Ω–µ –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)")
    for name in OLD_NAMES_SHOULD_NOT_EXIST:
        if name in product_map:
            print(f"  ‚ùå –í–°–Å –ï–©–Å –°–£–©–ï–°–¢–í–£–ï–¢: {name} (ID={product_map[name]['id']})")
            errors += 1
        else:
            print(f"  ‚úÖ –£–¥–∞–ª—ë–Ω/–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω: {name}")

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω
    print("\nüí∞ 3. –ü–†–û–í–ï–†–ö–ê –¶–ï–ù")
    for name, expected_price in EXPECTED_PRICES.items():
        if name in product_map:
            actual_price = product_map[name]["price_per_box"]
            if abs(actual_price - expected_price) < 0.1:
                print(f"  ‚úÖ {name}: {actual_price:,.1f} ‚Ç∏")
            else:
                print(f"  ‚ùå {name}: {actual_price:,.1f} ‚Ç∏ (–æ–∂–∏–¥–∞–ª–æ—Å—å {expected_price:,.1f} ‚Ç∏)")
                errors += 1
        else:
            print(f"  ‚ö†Ô∏è  {name}: —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (—Ü–µ–Ω–∞ –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞)")
            warnings += 1

    # 4. –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
    print(f"\nüì¶ 4. –í–°–ï –¢–û–í–ê–†–´ –í –ë–î ({len(products)} —à—Ç.)")
    for p in sorted(products, key=lambda x: x["id"]):
        print(f"  ID={p['id']:3d} | {p['price_per_box']:>10,.1f} ‚Ç∏ | {p['name_internal']}")

    # –ò—Ç–æ–≥
    print("\n" + "=" * 60)
    if errors == 0:
        print(f"‚úÖ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´! (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {warnings})")
    else:
        print(f"‚ùå –ù–ê–ô–î–ï–ù–û –û–®–ò–ë–û–ö: {errors}, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {warnings}")
    print("=" * 60)

    await db.pool.close()

asyncio.run(main())
